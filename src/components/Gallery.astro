---
import { Image } from "astro:assets";

interface Props {
  count?: number;
  title?: string;
  subtitle?: string;
}

const {
  count = 10,
  title = "Galería Fotográfica",
  subtitle = "Un vistazo a la magia de Zárate",
} = Astro.props;

// Get images from src/assets using glob
const imageFiles = import.meta.glob<{ default: ImageMetadata }>(
  "../assets/gallery-zarate/*.{jpeg,jpg,png,tiff,webp,gif,svg,avif}",
  { eager: true }
);

const images = Object.values(imageFiles).map((file) => file.default);

// Shuffle all images
const allImages = images.sort(() => 0.5 - Math.random());
const visibleImages = allImages.slice(0, count);
---

<section class="py-10 bg-zarate-light" id="galeria-section">
  <div class="max-w-7xl mx-auto px-6">
    <div class="text-center mb-16">
      <h2 class="text-4xl font-serif text-zarate-earth mb-4 gsap-fade-up">
        {title}
      </h2>
      <p class="text-slate-600 gsap-fade-up">
        {subtitle}
      </p>
    </div>

    <!-- 
      CSS Columns Masonry Implementation:
      - Better Performance (No Javascript required for layout)
      - Immune to 504/Network errors for JS libs
      - Native responsive support
    -->
    <div
      class="w-full relative pswp-gallery columns-2 md:columns-3 gap-4 lg:gap-6 space-y-4"
      id="gallery-grid"
    >
      {
        allImages.map((image, index) => {
          const isVisible = index < count;
          // Performance optimization: Eager load first 4 images (above fold likely)
          const isEager = index < 4;

          return (
            <a
              href={image.src}
              data-pswp-width={image.width}
              data-pswp-height={image.height}
              target="_blank"
              class={
                isVisible
                  ? "gallery-item block break-inside-avoid-column mb-4 group relative overflow-hidden rounded-2xl shadow-md cursor-pointer opacity-0 translate-y-10"
                  : "hidden"
              }
              data-index={index}
            >
              <Image
                src={image}
                alt={`Galería Zárate ${index + 1}`}
                class="w-full h-auto object-cover transition-transform duration-700 group-hover:scale-105"
                widths={[240, 480, 720]}
                sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 33vw"
                loading={isEager ? "eager" : "lazy"}
                fetchpriority={isEager ? "high" : "auto"}
                decoding="async"
              />
              <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-300 flex items-center justify-center">
                <span class="text-white text-4xl font-bold opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform scale-50 group-hover:scale-100">
                  +
                </span>
              </div>
            </a>
          );
        })
      }
    </div>
  </div>
</section>

<script>
  import gsap from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  import PhotoSwipeLightbox from "photoswipe/lightbox";
  import "photoswipe/style.css";

  gsap.registerPlugin(ScrollTrigger);

  const initGallery = async () => {
    const grid = document.getElementById("gallery-grid");
    if (!grid) return;

    // 1. Initialize PhotoSwipe (Lightbox)
    try {
      const lightbox = new PhotoSwipeLightbox({
        gallery: "#gallery-grid",
        children: "a",
        pswpModule: () => import("photoswipe"),
      });
      lightbox.init();
    } catch (error) {
      console.error("Lightbox failed to init:", error);
    }

    // 2. Animate Items (Simple Entrance)
    const galleryItems = document.querySelectorAll(".gallery-item");
    if (galleryItems.length > 0) {
      gsap.killTweensOf(galleryItems);
      gsap.fromTo(
        galleryItems,
        { y: 50, opacity: 0 },
        {
          scrollTrigger: {
            trigger: "#gallery-grid",
            start: "top 85%",
          },
          y: 0,
          opacity: 1,
          duration: 0.8,
          stagger: 0.05, // Faster stagger for better feel
          ease: "power3.out",
          onComplete: () => {
            // Cleanup to ensure visibility ensures
            galleryItems.forEach((item) => {
              (item as HTMLElement).style.opacity = "1";
              (item as HTMLElement).style.transform = "none";
            });
          },
        }
      );
    }
  };

  // Run on every page load (handles initial load and view transitions)
  document.addEventListener("astro:page-load", initGallery);
</script>
