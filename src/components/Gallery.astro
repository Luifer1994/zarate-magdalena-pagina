---
import { Image } from "astro:assets";

interface Props {
  count?: number;
  title?: string;
  subtitle?: string;
}

const {
  count = 10,
  title = "Galería Fotográfica",
  subtitle = "Un vistazo a la magia de Zárate",
} = Astro.props;

// Get images from src/assets using glob
const imageFiles = import.meta.glob<{ default: ImageMetadata }>(
  "../assets/gallery-zarate/*.{jpeg,jpg,png,tiff,webp,gif,svg,avif}",
  { eager: true }
);

const images = Object.values(imageFiles).map((file) => file.default);

// Shuffle all images
const allImages = images.sort(() => 0.5 - Math.random());
const visibleImages = allImages.slice(0, count);
---

<section class="py-10 bg-zarate-light" id="galeria-section">
  <div class="max-w-7xl mx-auto px-6">
    <div class="text-center mb-16">
      <h2 class="text-4xl font-serif text-zarate-earth mb-4 gsap-fade-up">
        {title}
      </h2>
      <p class="text-slate-500 gsap-fade-up">
        {subtitle}
      </p>
    </div>

    <div class="w-full relative pswp-gallery" id="gallery-grid">
      <!-- Sizers for Masonry -->
      <div
        class="grid-sizer w-[calc(50%-0.5rem)] md:w-[calc(50%-1rem)] lg:w-[calc(33.333%-1.34rem)]"
      >
      </div>
      <div class="gutter-sizer w-4 md:w-8"></div>

      {
        allImages.map((image, index) => {
          const isVisible = index < count;
          return (
            <a
              href={image.src}
              data-pswp-width={image.width}
              data-pswp-height={image.height}
              target="_blank"
              class={
                isVisible
                  ? "gallery-item w-[calc(50%-0.5rem)] md:w-[calc(50%-1rem)] lg:w-[calc(33.333%-1.34rem)] mb-4 md:mb-8 group relative overflow-hidden rounded-2xl shadow-md cursor-pointer opacity-0 translate-y-10 block"
                  : "hidden"
              }
              data-index={index}
            >
              <Image
                src={image}
                alt={`Fotografía de Zárate ${index + 1}: paisajes y vida cotidiana`}
                loading={index < 3 ? "eager" : "lazy"}
                fetchpriority={index < 3 ? "auto" : "low"}
                decoding="async"
                class="w-full h-auto object-cover transition-transform duration-700 group-hover:scale-105"
                widths={[240, 540, 720]}
                quality={60}
                sizes="(max-width: 768px) 50vw, (max-width: 1200px) 50vw, 33vw"
              />
              <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-300 flex items-center justify-center">
                <span class="text-white text-4xl font-bold opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform scale-50 group-hover:scale-100">
                  +
                </span>
              </div>
            </a>
          );
        })
      }
    </div>
  </div>
</section>

<script>
  import gsap from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  import Masonry from "masonry-layout";
  import imagesLoaded from "imagesloaded";
  import PhotoSwipeLightbox from "photoswipe/lightbox";
  import "photoswipe/style.css";

  gsap.registerPlugin(ScrollTrigger);

  const initGallery = () => {
    const grid = document.getElementById("gallery-grid");
    if (!grid) return;

    // Destroy existing Masonry instance if it exists (though simple re-new often works)
    // Initialize Masonry
    imagesLoaded(grid, function () {
      new Masonry(grid, {
        itemSelector: ".gallery-item",
        columnWidth: ".grid-sizer",
        gutter: ".gutter-sizer",
        percentPosition: true,
      });

      // Force layout after a small delay to ensure images are okay
      // msnry.layout();

      // Animate items
      const galleryItems = document.querySelectorAll(".gallery-item");
      if (galleryItems.length > 0) {
        // Kill old animations to prevent sync issues
        gsap.killTweensOf(galleryItems);

        gsap.fromTo(
          galleryItems,
          { y: 50, opacity: 0 },
          {
            scrollTrigger: {
              trigger: "#gallery-grid",
              start: "top 85%",
            },
            y: 0,
            opacity: 1,
            duration: 0.8,
            stagger: 0.1,
            ease: "power3.out",
            onComplete: () => {
              // Ensure visibility persists
              galleryItems.forEach((item) => {
                (item as HTMLElement).style.opacity = "1";
                (item as HTMLElement).style.transform = "none";
              });
            },
          }
        );
      }
    });

    // Initialize PhotoSwipe
    const lightbox = new PhotoSwipeLightbox({
      gallery: "#gallery-grid",
      children: "a",
      pswpModule: () => import("photoswipe"),
    });
    lightbox.init();
  };

  // Run on every page load (handles initial load and view transitions)
  document.addEventListener("astro:page-load", initGallery);
</script>
